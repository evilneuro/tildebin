#!/bin/sh

ADDURL=http://www.lugradio.org/addmirror
AUDLOC=http://audio.lugradio.org
MIRURL=http://meeja.net/mirrors/lugradio
MIRLOC=/store/mirrors/audio.lugradio.org

cd $MIRLOC

if [ "$1" = "--down" ]; then
	COUNT=0
	MATCH=0
	CHECK=""
	GETURL=""
	until [ "$CHECK" != "" ]
	do
		COUNT=`expr $COUNT + 1`
		CHECK=`curl --head --silent http://audio.lugradio.org/season$COUNT/ | head -1 | grep 404`
		if [ "$CHECK" = "" ]
		then
			MATCH=`expr $MATCH + 1`
			GETURL="$GETURL $AUDLOC/season$COUNT/"
		fi
	done
	
	cd ..
	wget -r -m -np -c $GETURL
	cd $MIRLOC
	rm -rfv `find -type f | grep index.html`
fi

if [ "$1" = "--up" ]; then
	sitecopy -u lrmirror
fi

if [ "$1" = "--register" ]; then
	for FILE in `find -type f | grep -v "._"`
	do
		# echo $FILE
		mkdir -p checks
		FILECHECK=checks/`echo $FILE | sed 's/\//_/g'`.check
		# echo $FILECHECK
		if [ ! -s $FILECHECK ]
		then
			echo -n "Registering `basename $FILE` ..."
			AUDURL=`echo $FILE | cut -d/ -f2-`
			wget -q -O wget.log $ADDURL/$MIRURL/$AUDURL
			if [ "`grep 200 wget.log`" != "" ]
			then
				mv wget.log $FILECHECK
			else
				echo "$FILE: `cat wget.log`" >> ../alo.errors
				rm -f wget.log
			fi
			echo "done"
		else
			echo "Already registered $FILE"
		fi
	done
fi
